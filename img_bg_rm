#!/usr/bin/env bash
set -euo pipefail

# https://stackoverflow.com/questions/9155377/set-transparent-background-using-imagemagick-and-commandline-prompt
_img_bg_rm(){
   [ $# -ne 2  ] && echo "USAGE: $0 input.png output.png" >&2 && return 1
   [ ! -r "$1" ] && echo "input image $1 does not exist" >&2 && return 1
   local color=$( convert "$1" -format "%[pixel:p{0,0}]" info:- )
   convert "$1" -alpha off -bordercolor $color -border 1 \
      \( +clone -fuzz 30% -fill none -floodfill +0+0 $color \
      -alpha extract -geometry 200% -blur 0x0.5 \
      -morphology erode square:1 -geometry 50% \) \
      -compose CopyOpacity -composite -shave 1 "$2"
}

# run if script name is bg_rm
[ "$(basename $0)" == "img_bg_rm" ] && _img_bg_rm $@
